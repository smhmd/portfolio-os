import { useRef, useState } from 'react'

import { AppIcon, AppWrapper } from 'app/components'
import { WavyText } from 'app/components/WavyText'
import type { AppMetadata } from 'app/types'
import { iconToFavicon } from 'app/utils'

import { Timer } from './components'
import { analyzeTyping, sentences } from './lib'

export function meta() {
  return [
    { title: metadata.name },
    { name: 'description', content: 'App to test your typing speed' },
  ]
}

export function links() {
  const favicon = iconToFavicon(<metadata.Icon />)
  return [favicon]
}

export default function App() {
  const [typed, setTyped] = useState('')
  const startTimeRef = useRef<number | null>(null) // Track the start time
  const endTimeRef = useRef<number | null>(null) // Track the end time

  const handleInput = (e: React.FormEvent<HTMLParagraphElement>) => {
    // Normalize spaces/remove new lines
    // because we're using contenteditable
    const newInput = e.currentTarget.innerText
      .replace(/\u00A0/g, ' ')
      .replace(/\n/g, '')

    setTyped(newInput)

    // Start the timer upon the first input
    if (!startTimeRef.current) {
      startTimeRef.current = Date.now()
    }

    // If the user has typed the full sentence, stop the timer
    if (newInput.length >= sentences.length && !endTimeRef.current) {
      endTimeRef.current = Date.now()
    }
  }

  const handleReset = () => {
    startTimeRef.current = null
    endTimeRef.current = null
    setTyped('')
  }

  // Calculate time taken once the sentence is fully typed
  const { wpm, accuracy, errors } =
    endTimeRef.current && startTimeRef.current
      ? analyzeTyping(
          sentences,
          typed,
          (endTimeRef.current - startTimeRef.current) / 1000,
        )
      : { accuracy: 0, wpm: 0, errors: 0 }

  return (
    <AppWrapper
      isDark
      className='flex flex-col items-center justify-center gap-6 bg-[whitesmoke] p-4 font-mono text-black'>
      <h1 className='text-3xl font-black'>Typing Test</h1>
      {endTimeRef.current ? (
        <div className='flex flex-col items-center justify-center gap-y-4'>
          <div className='flex flex-col items-center justify-center'>
            <WavyText value={`WPM: ${Math.round(wpm)}`} />
            <WavyText value={`Accuracy: ${Math.round(accuracy)}%`} />
            <WavyText value={`Mistakes: ${errors}`} />
          </div>
          <button
            onClick={handleReset}
            className='cursor-pointer rounded bg-gray-900 px-4 py-2 text-xs text-white hover:bg-gray-800'>
            Try Again
          </button>
        </div>
      ) : (
        <>
          <div className='relative flex w-full max-w-3xl cursor-text items-start rounded bg-white p-2.5 sm:p-4'>
            <p className='select-none'>
              {sentences.split('').map((char, index) => {
                let className = ''
                const letter = typed[index]
                if (typed.length > 0 && index < typed.length) {
                  className =
                    letter === char
                      ? 'text-green-600 bg-green-100'
                      : 'text-red-600 bg-red-100'
                }
                return (
                  <span key={index} className={className}>
                    {char}
                  </span>
                )
              })}
            </p>
            <p
              role='textbox'
              className='absolute inset-0 z-10 select-none p-2.5 text-transparent caret-black outline-none sm:p-4'
              contentEditable={!endTimeRef.current}
              autoFocus
              spellCheck={false}
              onInput={handleInput}
              onCopy={(e) => e.preventDefault()}
              onCut={(e) => e.preventDefault()}
              onPaste={(e) => e.preventDefault()}
              onKeyDown={(e) => {
                if (
                  // Prevent certain keys (like inserting new lines with enter)
                  ['Enter'].includes(e.key) ||
                  // Prevent Ctrl + A (Command + A on Mac)
                  ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'a')
                  // Prevent Cmd + Backspace (Mac) or Ctrl + Backspace (Windows/Linux)
                  // ((e.ctrlKey || e.metaKey || e.altKey) && e.key === 'Backspace')
                ) {
                  e.preventDefault()
                }
              }}
            />
          </div>
          {startTimeRef.current ? (
            <Timer />
          ) : (
            <WavyText value='Start typing to begin!' />
          )}
        </>
      )}
    </AppWrapper>
  )
}

export const metadata: AppMetadata = {
  id: 'typing-test',
  name: 'Typing Test',
  Icon: (props) => (
    <AppIcon fill='#65c4db' {...props}>
      <path
        d='m11.18 65-.175 2.82c-.091 1.6 1.111 2.18 2.281 2.18h73.415c1.17 0 2.38-.42 2.295-2.277L88.82 65H11.18Z'
        fill='#2F7889'
      />
      <path
        d='M86.828 67H13.165C11.991 67 11 66.013 11 64.843l1.918-32.686c0-1.234.99-2.157 2.165-2.157h69.834c1.174 0 2.165.988 2.165 2.157L89 64.843c0 1.17-.991 2.157-2.172 2.157Z'
        fill='#C3D2D9'
      />
      <path
        d='M16.215 39.51c0 .645.454 1.098 1.032 1.098h3.067c.578 0 1.032-.512 1.032-1.097L21.438 38h-5.085l-.138 1.51Zm7.726 0c0 .645.453 1.098 1.03 1.098h3.023c.65 0 1.031-.46 1.031-1.097V38H23.96l-.02 1.51Zm7.271 0c0 .645.513 1.098 1.098 1.098h3.021c.578 0 1.097-.427 1.097-1.097V38h-5.215v1.51Zm7.397 0c0 .645.513 1.098 1.097 1.098h3.022c.578 0 1.097-.394 1.097-1.097V38H38.61v1.51Zm7.338 0c0 .645.427 1.098 1.097 1.098h3.022c.578 0 1.097-.335 1.097-1.097V38h-5.216v1.51Zm7.403 0c0 .645.513 1.098 1.097 1.098h3.022c.578 0 1.097-.335 1.097-1.097V38H53.35v1.51Zm7.338 0c0 .645.512 1.098 1.097 1.098h3.022c.578 0 1.064-.276 1.097-1.097V38h-5.216v1.51Zm7.331 0c0 .645.512 1.098 1.097 1.098h3.16c.676 0 1.215-.447 1.156-1.156L73.347 38h-5.328v1.51Zm7.725 0c0 .645.513 1.098 1.097 1.098h5.827a1.09 1.09 0 0 0 1.097-1.097L83.66 38h-7.91v1.51h-.006Zm2.72 7.72c0 .578.512 1.096 1.097 1.096h3.573a1.09 1.09 0 0 0 1.097-1.097l-.065-.978H78.47v.978h-.006Zm-7.482 0a1.09 1.09 0 0 0 1.097 1.096H75.1a1.09 1.09 0 0 0 1.098-1.097v-.978h-5.216v.978Zm-7.404 0c.066.578.513 1.096 1.097 1.096h3.022a1.09 1.09 0 0 0 1.097-1.097v-.978h-5.216v.978Zm-7.33 0c0 .578.512 1.096 1.096 1.096h3.022a1.09 1.09 0 0 0 1.097-1.097v-.978h-5.216v.978Zm-7.404 0c.066.578.512 1.096 1.097 1.096h3.022a1.09 1.09 0 0 0 1.097-1.097v-.978h-5.216v.978Zm-7.338 0c0 .578.513 1.096 1.097 1.096h3.022a1.09 1.09 0 0 0 1.097-1.097v-.978h-5.216v.978Zm-7.337 0c0 .578.512 1.096 1.097 1.096h3.021a1.09 1.09 0 0 0 1.097-1.097v-.978H34.17v.978Zm-7.338 0c0 .578.453 1.096 1.031 1.096h3.022a1.09 1.09 0 0 0 1.097-1.097v-.978h-5.15v.978Zm-11.043 0c0 .578.454 1.096 1.032 1.096h6.345c.579 0 1.032-.453 1.032-1.097v-.978l-8.402-.02-.007.998Zm44.578 7.922c0 .532.453 1.064 1.031 1.064h3.022c.578 0 1.032-.467 1.032-1.064v-.9h-5.085v.9Zm-7.725 0c0 .532.453 1.064 1.031 1.064h3.022c.578 0 1.031-.467 1.031-1.064l-.006-.9H52.64v.9Zm-7.725 0c0 .532.453 1.064 1.03 1.064h3.023c.578 0 1.031-.467 1.031-1.064v-.9h-5.084v.9Zm-7.72 0c-.065.532.454 1.064 1.032 1.064h3.022c.578 0 1.031-.467 1.031-1.064v-.9h-5.084v.9Zm-7.724 0c-.066.532.453 1.064 1.031 1.064h3.022c.578 0 1.031-.467 1.031-1.064v-.723h-5.084v.723Zm-13.966-.066c0 .598.453 1.13 1.031 1.13H25.4c.578 0 1.031-.467 1.031-1.13l.08-.86H15.518l-.013.86Zm52.92.066c.066.663.513 1.13 1.097 1.13h14.012c.578 0 1.097-.467 1.097-1.13l-.006-.927-16.213.033.013.894ZM79.876 64h4.027c.578 0 1.097-.473 1.097-1.143v-1.018h-6.22v1.018c0 .61.518 1.143 1.096 1.143Zm-8.441 0h3.416c.578 0 1.097-.473 1.097-1.143v-1.07l-5.604.052v1.018c-.006.61.447 1.143 1.09 1.143ZM33.59 64h32.82c.578 0 1.097-.473 1.097-1.143v-1.018H32.493l.007 1.018c0 .782.512 1.143 1.09 1.143Zm-8.277 0h3.324c.578 0 1.098-.473 1.098-1.143v-1.018l-5.387.118.006.9c-.026.65.381 1.143.96 1.143Zm-9.288 0h4.21c.579 0 1.032-.473 1.032-1.143v-1.018H15v1.018c-.007.61.44 1.143 1.025 1.143Z'
        fill='#2F7889'
      />
      <path
        d='M20.366 39.907h-3.021c-.578 0-1.031-.422-1.031-1.031l.295-2.845c0-.545.453-1.031 1.031-1.031h3.022c.578 0 1.031.421 1.031 1.03l-.295 2.846c0 .544-.453 1.03-1.032 1.03Zm7.633 0h-3.021c-.579 0-1.032-.422-1.032-1.031l.112-2.845c0-.545.453-1.031 1.031-1.031H28c.578 0 1.031.421 1.031 1.03v2.846c0 .635-.387 1.03-1.031 1.03Zm7.337 0h-3.022c-.578 0-1.096-.422-1.096-1.031V36.03c0-.545.453-1.031 1.096-1.031h3.022c.578 0 1.097.421 1.097 1.03v2.846c-.007.544-.519 1.03-1.097 1.03Zm7.396 0h-3.021c-.578 0-1.097-.422-1.097-1.031V36.03c0-.545.453-1.031 1.097-1.031h3.021c.578 0 1.097.421 1.097 1.03v2.846c0 .616-.519 1.03-1.097 1.03Zm7.337 0h-3.022c-.578 0-1.096-.422-1.096-1.031V36.03c0-.545.453-1.031 1.096-1.031h3.022c.578 0 1.097.421 1.097 1.03v2.846c0 .544-.519 1.03-1.097 1.03Zm7.403 0H54.45c-.578 0-1.097-.422-1.097-1.031V36.03c0-.545.453-1.031 1.097-1.031h3.022c.578 0 1.096.421 1.096 1.03v2.846c-.006.642-.518 1.03-1.096 1.03Zm7.337 0h-3.022c-.578 0-1.097-.422-1.097-1.031V36.03c0-.545.453-1.031 1.097-1.031h3.022c.578 0 1.097.421 1.097 1.03v2.846c-.007.655-.52 1.03-1.097 1.03Zm7.468 0h-3.16c-.578 0-1.096-.422-1.096-1.031V36.03c0-.545.453-1.031 1.097-1.031h3.021c.578 0 1.097.421 1.097 1.03l.131 2.846c0 .544-.512 1.03-1.09 1.03Zm10.306 0h-5.741c-.578 0-1.097-.422-1.097-1.031V36.03c0-.545.453-1.031 1.097-1.031h5.596c.578 0 1.097.421 1.097 1.03l.145 2.846c-.007.544-.52 1.03-1.097 1.03Zm-3.028 7.7h3.573c.578 0 1.097-.422 1.097-1.031l-.204-2.845c0-.545-.453-1.031-1.097-1.031h-3.363c-.578 0-1.097.421-1.097 1.03v2.846c0 .544.513 1.03 1.09 1.03Zm-7.475 0H75.1c.578 0 1.097-.422 1.097-1.031V43.73c0-.545-.453-1.031-1.097-1.031H72.08c-.578 0-1.097.421-1.097 1.03v2.846c0 .544.453 1.03 1.097 1.03Zm-7.403 0H67.7c.578 0 1.097-.422 1.097-1.031V43.73c0-.545-.454-1.031-1.097-1.031h-3.022c-.578 0-1.097.421-1.097 1.03v2.846c.066.544.52 1.03 1.097 1.03Zm-7.337 0h3.022c.578 0 1.097-.422 1.097-1.031V43.73c0-.545-.454-1.031-1.097-1.031H57.34c-.578 0-1.097.421-1.097 1.03v2.846c.007.544.52 1.03 1.097 1.03Zm-7.396 0h3.022c.578 0 1.097-.422 1.097-1.031V43.73c0-.545-.454-1.031-1.097-1.031h-3.022c-.578 0-1.097.421-1.097 1.03v2.846c.066.544.513 1.03 1.097 1.03Zm-7.337 0h3.022c.578 0 1.097-.422 1.097-1.031V43.73c0-.545-.454-1.031-1.097-1.031h-3.022c-.578 0-1.097.421-1.097 1.03v2.846c0 .544.52 1.03 1.097 1.03Zm-7.337 0h3.022c.578 0 1.097-.422 1.097-1.031V43.73c0-.545-.454-1.031-1.097-1.031H35.27c-.578 0-1.097.421-1.097 1.03v2.846c0 .544.52 1.03 1.097 1.03Zm-7.402 0h3.021c.578 0 1.097-.422 1.097-1.031V43.73c0-.545-.453-1.031-1.097-1.031h-3.021c-.578 0-1.032.421-1.032 1.03v2.846c0 .544.454 1.03 1.032 1.03Zm-11.042 0h6.345c.578 0 1.031-.422 1.031-1.031V43.73c0-.545-.453-1.031-1.03-1.031h-6.116c-.578 0-1.031.421-1.031 1.03l-.23 2.846c0 .544.453 1.03 1.031 1.03Zm44.567 7.725h3.022c.578 0 1.03-.42 1.03-.965V51.52c0-.544-.452-.965-1.03-.965h-3.022c-.578 0-1.031.42-1.031.965v2.846c.006.48.453.965 1.031.965Zm-7.718 0h3.022c.578 0 1.03-.42 1.03-.965V51.52c0-.544-.452-.965-1.03-.965h-3.022c-.578 0-1.031.42-1.031.965v2.846c0 .48.453.965 1.031.965Zm-7.724 0h3.021c.578 0 1.031-.42 1.031-.965V51.52c0-.544-.453-.965-1.031-.965H45.95c-.578 0-1.03.42-1.03.965v2.846c0 .48.453.965 1.03.965Zm-7.725 0h3.022c.578 0 1.03-.42 1.03-.965V51.52c0-.544-.452-.965-1.03-.965h-3.022c-.578 0-1.031.42-1.031.965v2.846c.006.505.453.965 1.031.965Zm-7.718 0h3.022c.578 0 1.03-.42 1.03-.965V51.52c0-.544-.452-.965-1.03-.965h-3.022c-.578 0-1.031.42-1.031.965v2.846c-.066.48.453.965 1.031.965Zm-13.964 0h8.946c.578 0 1.031-.42 1.031-1.03l.19-2.846c0-.544-.453-1.03-1.03-1.03h-8.986c-.578 0-1.032.421-1.032 1.03l-.15 2.846c0 .544.453 1.03 1.03 1.03Zm52.941.059H83.53c.578 0 1.097-.422 1.097-1.03l-.224-3.028c0-.544-.453-1.03-1.097-1.03H69.321c-.578 0-1.097.421-1.097 1.03l.164 3.027c.066.61.52 1.03 1.097 1.03ZM79.877 63h4.026c.578 0 1.097-.421 1.097-1.03l-.19-2.846c0-.544-.454-1.03-1.097-1.03h-3.836c-.578 0-1.097.42-1.097 1.03v2.845c0 .545.519 1.031 1.097 1.031Zm-8.44 0h3.415c.578 0 1.097-.421 1.097-1.03v-2.846c0-.544-.453-1.03-1.097-1.03h-3.416c-.578 0-1.097.42-1.097 1.03v2.845c0 .545.453 1.031 1.097 1.031Zm-37.842 0h32.816c.578 0 1.097-.421 1.097-1.03v-2.846c0-.544-.453-1.03-1.097-1.03H33.595c-.578 0-1.097.42-1.097 1.03v2.845c-.052.662.52 1.031 1.097 1.031Zm-8.276 0h3.324c.578 0 1.097-.421 1.097-1.03v-2.846c0-.544-.454-1.03-1.032-1.03l-3.343.012c-.578 0-1.031.422-1.031 1.031l.02 2.832c-.02.577.387 1.031.965 1.031Zm-9.288 0h4.21c.579 0 1.032-.421 1.032-1.03v-2.846c0-.544-.453-1.03-1.031-1.03h-3.928c-.578 0-1.032.42-1.032 1.03L15 61.97c0 .545.447 1.031 1.031 1.031Z'
        fill='#fff'
      />
    </AppIcon>
  ),
}
